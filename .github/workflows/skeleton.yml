name: Create SFDC Project Skeleton

on:  
  workflow_dispatch:  
    inputs: 
      branch_name: 
        description: 'Branch name for the SFDC skeleton (new or existing)'
        required: true
        default: 'sfdc-project'
      project_name:  
        description:  'Salesforce project name'
        required: true
        default: 'my-sfdc-project'
      api_version: 
        description: 'Salesforce API version'
        required: true
        default: '59.0'

jobs: 
  create-skeleton: 
    runs-on: ubuntu-latest
    
    steps: 
      # ---------------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # ---------------------------------------------------------
      - name:  Checkout code
        uses: actions/checkout@v4
        with: 
          fetch-depth:  0

      # ---------------------------------------------------------
      # 2ï¸âƒ£ Configure Git
      # ---------------------------------------------------------
      - name:  Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply. github.com"

      # ---------------------------------------------------------
      # 3ï¸âƒ£ Checkout branch (existing or new)
      # ---------------------------------------------------------
      - name: Checkout branch
        run: |
          BRANCH="${{ github.event.inputs. branch_name }}"
          
          # Fetch all remote branches
          git fetch origin
          
          # Check if branch exists remotely
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            echo "âœ… Branch '$BRANCH' exists.  Checking out..."
            git checkout "$BRANCH"
            git pull origin "$BRANCH"
          else
            echo "ðŸŒ¿ Branch '$BRANCH' does not exist.  Creating new branch..."
            git checkout -b "$BRANCH"
          fi
          
          echo "ðŸ“ Current branch: $(git branch --show-current)"

      # ---------------------------------------------------------
      # 4ï¸âƒ£ Create SFDC Project Structure
      # ---------------------------------------------------------
      - name:  Create SFDC Skeleton
        run:  |
          echo "ðŸ“¦ Creating Salesforce project skeleton..."
          
          PROJECT_NAME="${{ github.event.inputs. project_name }}"
          API_VERSION="${{ github.event.inputs.api_version }}"
          
          # Create directory structure
          mkdir -p force-app/main/default/classes
          mkdir -p force-app/main/default/triggers
          mkdir -p force-app/main/default/lwc
          mkdir -p force-app/main/default/aura
          mkdir -p force-app/main/default/objects
          mkdir -p force-app/main/default/layouts
          mkdir -p force-app/main/default/flows
          mkdir -p force-app/main/default/permissionsets
          mkdir -p force-app/main/default/profiles
          mkdir -p force-app/main/default/staticresources
          mkdir -p force-app/main/default/tabs
          mkdir -p force-app/main/default/pages
          mkdir -p force-app/main/default/components
          mkdir -p force-app/main/default/email
          mkdir -p force-app/main/default/queues
          mkdir -p force-app/main/default/reports
          mkdir -p force-app/main/default/dashboards
          mkdir -p scripts/apex
          mkdir -p config
          mkdir -p .vscode
          
          echo "âœ… Directory structure created"

      # ---------------------------------------------------------
      # 5ï¸âƒ£ Create sfdx-project. json
      # ---------------------------------------------------------
      - name: Create sfdx-project.json
        run: |
          API_VERSION="${{ github.event.inputs. api_version }}"
          PROJECT_NAME="${{ github.event.inputs. project_name }}"
          
          cat > sfdx-project. json << EOF
          {
            "packageDirectories": [
              {
                "path": "force-app",
                "default": true
              }
            ],
            "name": "${PROJECT_NAME}",
            "namespace": "",
            "sfdcLoginUrl": "https://login.salesforce. com",
            "sourceApiVersion": "${API_VERSION}"
          }
          EOF
          
          echo "âœ… sfdx-project.json created"

      # ---------------------------------------------------------
      # 6ï¸âƒ£ Create .forceignore
      # ---------------------------------------------------------
      - name: Create .forceignore
        run: |
          cat > .forceignore << 'EOF'
          # List files or directories below to ignore them when running force:source: push, force:source:pull, and force:source:status

          package. xml

          # LWC configuration files
          **/jsconfig.json
          **/. eslintrc.json

          # LWC Jest
          **/__tests__/**

          # Admin Profile
          **/profiles/Admin.profile-meta.xml

          # Ignore specific metadata
          **/appMenus/**
          **/objectTranslations/**
          **/connectedApps/**
          EOF
          
          echo "âœ… . forceignore created"

      # ---------------------------------------------------------
      # 7ï¸âƒ£ Create . gitignore
      # ---------------------------------------------------------
      - name: Create . gitignore for SFDC
        run: |
          cat > .gitignore << 'EOF'
          # Salesforce
          .sf/
          .sfdx/
          . localdevserver/

          # LWC
          **/lwc/**/*. css. map
          **/lwc/**/*.js. map

          # Logs
          *.log
          logs/

          # OS Files
          .DS_Store
          Thumbs.db

          # IDE
          .idea/
          *.sublime-project
          *.sublime-workspace

          # Node
          node_modules/
          package-lock.json

          # Auth files
          authfile.txt
          *.key
          *.crt

          # Deployment
          deployment-result.json
          changed-files.txt
          delta-package/
          EOF
          
          echo "âœ… . gitignore updated"

      # ---------------------------------------------------------
      # 8ï¸âƒ£ Create VS Code settings
      # ---------------------------------------------------------
      - name: Create VS Code settings
        run:  |
          cat > .vscode/settings.json << 'EOF'
          {
            "editor.formatOnSave": true,
            "editor.tabSize": 4,
            "salesforcedx-vscode-apex. java.home": "",
            "search.exclude": {
              "**/node_modules":  true,
              "**/bower_components": true,
              "**/.sfdx": true,
              "**/. sf":  true
            }
          }
          EOF
          
          cat > .vscode/extensions.json << 'EOF'
          {
            "recommendations":  [
              "salesforce.salesforcedx-vscode",
              "salesforce.salesforcedx-vscode-apex",
              "salesforce.salesforcedx-vscode-lwc",
              "redhat.vscode-xml"
            ]
          }
          EOF
          
          echo "âœ… VS Code settings created"

      # ---------------------------------------------------------
      # 9ï¸âƒ£ Create sample Apex class
      # ---------------------------------------------------------
      - name:  Create sample Apex class
        run: |
          API_VERSION="${{ github.event.inputs. api_version }}"
          
          # Only create if doesn't exist
          if [ ! -f "force-app/main/default/classes/HelloWorld.cls" ]; then
            cat > force-app/main/default/classes/HelloWorld.cls << 'EOF'
          /**
           * @description Sample Apex class
           */
          public with sharing class HelloWorld {
              public static String sayHello(String name) {
                  if (String.isBlank(name)) {
                      return 'Hello, World!';
                  }
                  return 'Hello, ' + name + '!';
              }
          }
          EOF
            
            cat > force-app/main/default/classes/HelloWorld.cls-meta.xml << EOF
          <? xml version="1.0" encoding="UTF-8"?>
          <ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
              <apiVersion>${API_VERSION}</apiVersion>
              <status>Active</status>
          </ApexClass>
          EOF
            
            cat > force-app/main/default/classes/HelloWorldTest.cls << 'EOF'
          @isTest
          private class HelloWorldTest {
              @isTest
              static void testSayHello() {
                  System.assertEquals('Hello, World!', HelloWorld.sayHello(null));
                  System.assertEquals('Hello, Test!', HelloWorld. sayHello('Test'));
              }
          }
          EOF
            
            cat > force-app/main/default/classes/HelloWorldTest. cls-meta.xml << EOF
          <? xml version="1.0" encoding="UTF-8"?>
          <ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
              <apiVersion>${API_VERSION}</apiVersion>
              <status>Active</status>
          </ApexClass>
          EOF
            
            echo "âœ… Sample Apex classes created"
          else
            echo "â­ï¸ HelloWorld.cls already exists, skipping..."
          fi

      # ---------------------------------------------------------
      # ðŸ”Ÿ Create sample LWC
      # ---------------------------------------------------------
      - name: Create sample LWC
        run: |
          API_VERSION="${{ github.event. inputs.api_version }}"
          
          # Only create if doesn't exist
          if [ ! -d "force-app/main/default/lwc/helloWorld" ]; then
            mkdir -p force-app/main/default/lwc/helloWorld
            
            cat > force-app/main/default/lwc/helloWorld/helloWorld.html << 'EOF'
          <template>
              <lightning-card title="Hello World" icon-name="custom: custom14">
                  <div class="slds-p-horizontal_small">
                      <lightning-input label="Enter your name" value={name} onchange={handleNameChange}></lightning-input>
                      <p class="slds-p-top_medium"><strong>{greeting}</strong></p>
                  </div>
              </lightning-card>
          </template>
          EOF
            
            cat > force-app/main/default/lwc/helloWorld/helloWorld. js << 'EOF'
          import { LightningElement, track } from 'lwc';

          export default class HelloWorld extends LightningElement {
              @track name = '';

              get greeting() {
                  return this.name ? `Hello, ${this.name}!` : 'Hello, World! ';
              }

              handleNameChange(event) {
                  this.name = event.target.value;
              }
          }
          EOF
            
            cat > force-app/main/default/lwc/helloWorld/helloWorld. js-meta.xml << EOF
          <? xml version="1.0" encoding="UTF-8"?>
          <LightningComponentBundle xmlns="http://soap.sforce.com/2006/04/metadata">
              <apiVersion>${API_VERSION}</apiVersion>
              <isExposed>true</isExposed>
              <targets>
                  <target>lightning__AppPage</target>
                  <target>lightning__RecordPage</target>
                  <target>lightning__HomePage</target>
              </targets>
          </LightningComponentBundle>
          EOF
            
            echo "âœ… Sample LWC created"
          else
            echo "â­ï¸ helloWorld LWC already exists, skipping..."
          fi

      # ---------------------------------------------------------
      # 1ï¸âƒ£1ï¸âƒ£ Create README
      # ---------------------------------------------------------
      - name: Create README
        run: |
          PROJECT_NAME="${{ github.event.inputs. project_name }}"
          API_VERSION="${{ github.event.inputs.api_version }}"
          
          cat > README.md << EOF
          # ${PROJECT_NAME}

          Salesforce DX Project - API Version ${API_VERSION}

          ## ðŸš€ Getting Started

          1. **Authorize your org**
             \`\`\`bash
             sf org login web --alias myorg --set-default
             \`\`\`

          2. **Deploy to your org**
             \`\`\`bash
             sf project deploy start --source-dir force-app --target-org myorg
             \`\`\`

          3. **Run tests**
             \`\`\`bash
             sf apex run test --target-org myorg --test-level RunLocalTests
             \`\`\`
          EOF
          
          echo "âœ… README. md created"

      # ---------------------------------------------------------
      # 1ï¸âƒ£2ï¸âƒ£ Create placeholder files
      # ---------------------------------------------------------
      - name: Create placeholder files
        run: |
          touch force-app/main/default/triggers/. gitkeep
          touch force-app/main/default/aura/.gitkeep
          touch force-app/main/default/objects/.gitkeep
          touch force-app/main/default/layouts/.gitkeep
          touch force-app/main/default/flows/.gitkeep
          touch force-app/main/default/permissionsets/.gitkeep
          touch force-app/main/default/profiles/. gitkeep
          touch force-app/main/default/staticresources/.gitkeep
          touch force-app/main/default/tabs/.gitkeep
          touch force-app/main/default/pages/. gitkeep
          touch force-app/main/default/components/.gitkeep
          touch scripts/apex/. gitkeep
          touch config/. gitkeep
          
          echo "âœ… Placeholder files created"

      # ---------------------------------------------------------
      # 1ï¸âƒ£3ï¸âƒ£ Commit and Push
      # ---------------------------------------------------------
      - name:  Commit and Push
        run: |
          BRANCH="${{ github. event.inputs.branch_name }}"
          
          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit.  Skeleton may already exist."
          else
            git add . 
            git commit -m "ðŸŽ‰ Add Salesforce DX project skeleton

          - SFDX project structure
          - API Version: ${{ github.event. inputs.api_version }}
          - Sample Apex class and LWC

          Generated by GitHub Actions"
            
            git push origin "$BRANCH"
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… SFDC Skeleton Created Successfully!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸŒ¿ Branch: $BRANCH"
            echo "ðŸ“¦ Project: ${{ github.event.inputs.project_name }}"
            echo "ðŸ”¢ API Version: ${{ github.event. inputs.api_version }}"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi
