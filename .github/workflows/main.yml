name: Deploy to Salesforce

on:
  push:
    branches:
      - Praveen_dev_zuariCp

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SALESFORCE_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias deployment-org --set-default

      - name: Check if anything to deploy
        id: check_changes
        run: |
          git fetch origin
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "Checking HEAD~1"
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^force-app/' || true)
          else
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^force-app/' || true)
          fi
          echo "Changed files: $CHANGED"
          if [ -z "$CHANGED" ]; then
            echo "deploy=false" >> $GITHUB_OUTPUT
          else
            echo "deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Clear source tracking
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          sf project delete tracking --target-org deployment-org --no-prompt || true

      - name: Deploy to Salesforce
        id: deploy
        if: steps.check_changes.outputs.deploy == 'true'
        continue-on-error: true
        run: |
          echo "Starting deployment..."
          sf project deploy start --source-dir force-app --target-org deployment-org --wait 30 --test-level RunLocalTests --json > deployment-result.json || true
          cat deployment-result.json

      - name: Display Deployment Summary
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          echo "Deployment Summary:"
          echo "=================="
          
          if [ -f deployment-result.json ]; then
            STATUS=$(jq -r '.status // "UNKNOWN"' deployment-result.json)
            echo "Status: $STATUS"
            
            # Success
            echo ""
            echo "Successfully Deployed:"
            jq -r '.result.deployedSource[]? | "- " + .type + ": " + .fullName' deployment-result.json 2>/dev/null || echo " None"
            
            # Failures
            echo ""
            echo "Failed Components:"
            jq -r '.result.details.componentFailures[]? | "- " + .componentType + ": " + .fullName + " (Error: " + .problem + ")"' deployment-result.json 2>/dev/null || echo " None"
            
            # Tests - SIMPLIFIED VERSION
            echo ""
            echo "Test Results:"
            TESTS_RUN=$(jq -r '.result.details.runTestResult?.numTestsRun // 0' deployment-result.json 2>/dev/null)
            TESTS_PASSED=$(jq -r '.result.details.runTestResult?.numTestsPassed // 0' deployment-result.json 2>/dev/null)
            TESTS_FAILED=$(jq -r '.result.details.runTestResult?.numFailures // 0' deployment-result.json 2>/dev/null)
            
            if [ "$TESTS_RUN" -gt 0 ]; then
              echo "Total: $TESTS_RUN Passed: $TESTS_PASSED Failed: $TESTS_FAILED"
            else
              echo "No tests run"
            fi
          else
            echo "No deployment result file found"
          fi

      - name: Upload deployment results
        if: always() && steps.check_changes.outputs.deploy == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: deployment-results
          path: deployment-result.json
          retention-days: 30

      - name: Check deployment status
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          if [ -f deployment-result.json ]; then
            STATUS=$(jq -r '.status // "UNKNOWN"' deployment-result.json)
            if [ "$STATUS" = "Failed" ]; then
              echo "Deployment failed"
              exit 1
            elif [ "$STATUS" = "SucceededPartial" ]; then
              echo "Deployment partially succeeded"
            else
              echo "Deployment completed"
            fi
          fi

      - name: No changes to deploy
        if: steps.check_changes.outputs.deploy == 'false'
        run: echo "No Salesforce metadata changes. Skipping deployment."

      - name: Cleanup
        if: always()
        run: rm -f authfile.txt
