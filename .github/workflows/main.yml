name: Deploy to Salesforce

on:
  push:
    branches:
      - Praveen_dev_zuariCp

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2Ô∏è‚É£ Install Salesforce CLI
      # ---------------------------------------------------------
      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version

      # ---------------------------------------------------------
      # 3Ô∏è‚É£ Authenticate to Salesforce
      # ---------------------------------------------------------
      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SALESFORCE_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias deployment-org --set-default

      # ---------------------------------------------------------
      # 4Ô∏è‚É£ Check if any Salesforce metadata changed
      # ---------------------------------------------------------
      - name: Check if anything to deploy
        id: check_changes
        run: |
          git fetch origin

          # Handle first push or missing before commit
          if [ -z "${{ github.event.before }}" ] || [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "‚ö†Ô∏è No previous commit found. Checking HEAD~1"
            CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^force-app/' || true)
          else
            echo "Checking changes between:"
            echo "${{ github.event.before }} -> ${{ github.sha }}"
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^force-app/' || true)
          fi

          echo "Changed files:"
          echo "$CHANGED"

          if [ -z "$CHANGED" ]; then
            echo "‚ùå No Salesforce metadata changes found."
            echo "deploy=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Salesforce metadata changes detected."
            echo "deploy=true" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # 5Ô∏è‚É£ Clear source tracking to avoid "Nothing to Deploy"
      # ---------------------------------------------------------
      - name: Clear source tracking
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          sf project delete tracking --target-org deployment-org --no-prompt || true

      # ---------------------------------------------------------
      # 6Ô∏è‚É£ Deploy to Salesforce (with error handling)
      # ---------------------------------------------------------
      - name: Deploy to Salesforce
        id: deploy
        if: steps.check_changes.outputs.deploy == 'true'
        continue-on-error: true  # Don't fail the workflow on deployment errors
        run: |
          echo "üöÄ Starting deployment..."
          
          sf project deploy start \
            --source-dir force-app \
            --target-org deployment-org \
            --wait 30 \
            --test-level RunLocalTests \
            --json > deployment-result.json || true
          
          # Display results
          cat deployment-result.json

      # ---------------------------------------------------------
      # 7Ô∏è‚É£ Parse and display deployment results
      # ---------------------------------------------------------
      - name: Display Deployment Summary
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          echo "üìä Deployment Summary:"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          if [ -f deployment-result.json ]; then
            # Check deployment status
            STATUS=$(cat deployment-result.json | jq -r '.status // "UNKNOWN"')
            
            echo "Status: $STATUS"
            
            # Show successful deployments
            echo ""
            echo "‚úÖ Successfully Deployed:"
            cat deployment-result.json | jq -r '.result.deployedSource[]? | "  - \(.type): \(.fullName)"' || echo "  None"
            
            # Show failures
            echo ""
            echo "‚ùå Failed Components:"
            cat deployment-result.json | jq -r '.result.details.componentFailures[]? | "  - \(.componentType): \(.fullName)
    Error: \(.problem)"' || echo "  None"
            
            # Show test results if any
            echo ""
            echo "üß™ Test Results:"
            TEST_RESULTS=$(cat deployment-result.json | jq -r '.result.details.runTestResult? | "Total: \(.numTestsRun // 0) Passed: \(.numTestsPassed // 0) Failed: \(.numFailures // 0)"' 2>/dev/null)
            if [ -z "$TEST_RESULTS" ] || [ "$TEST_RESULTS" = "null" ]; then
              echo "  No tests run"
            else
              echo "  $TEST_RESULTS"
            fi
            
          else
            echo "‚ö†Ô∏è No deployment result file found"
          fi

      # ---------------------------------------------------------
      # 8Ô∏è‚É£ Upload deployment results as artifact
      # ---------------------------------------------------------
      - name: Upload deployment results
        if: always() && steps.check_changes.outputs.deploy == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: deployment-results
          path: deployment-result.json
          retention-days: 30

      # ---------------------------------------------------------
      # 9Ô∏è‚É£ Fail workflow only if deployment completely failed
      # ---------------------------------------------------------
      - name: Check deployment status
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          if [ -f deployment-result.json ]; then
            STATUS=$(cat deployment-result.json | jq -r '.status // "UNKNOWN"')
            
            if [ "$STATUS" == "Failed" ]; then
              echo "‚ùå Deployment failed. Please check the errors above."
              exit 1
            elif [ "$STATUS" == "SucceededPartial" ]; then
              echo "‚ö†Ô∏è Deployment partially succeeded. Some components failed."
              echo "Check the summary above for details."
              exit 0  # Don't fail workflow for partial success
            else
              echo "‚úÖ Deployment completed successfully!"
            fi
          fi

      # ---------------------------------------------------------
      # üîü Log when nothing to deploy
      # ---------------------------------------------------------
      - name: No changes to deploy
        if: steps.check_changes.outputs.deploy == 'false'
        run: echo "‚ÑπÔ∏è No Salesforce metadata changes detected. Skipping deployment."

      # ---------------------------------------------------------
      # 1Ô∏è‚É£1Ô∏è‚É£ Cleanup
      # ---------------------------------------------------------
      - name: Cleanup
        if: always()
        run: rm -f authfile.txt
