name: Deploy to Salesforce

on:
  push:
    branches: 
      - Praveen_dev_zuariCp

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # ---------------------------------------------------------
      - name:  Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2ï¸âƒ£ Install Salesforce CLI
      # ---------------------------------------------------------
      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version

      # ---------------------------------------------------------
      # 3ï¸âƒ£ Authenticate to Salesforce
      # ---------------------------------------------------------
      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SALESFORCE_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias deployment-org --set-default

      # ---------------------------------------------------------
      # 4ï¸âƒ£ Deploy to Salesforce - IGNORE ERRORS, DEPLOY WHAT YOU CAN
      # ---------------------------------------------------------
      - name: Deploy to Salesforce
        run: |
          echo "ğŸš€ Starting deployment..."
          
          sf project deploy start \
            --source-dir force-app \
            --target-org deployment-org \
            --wait 60 \
            --test-level RunLocalTests \
            --ignore-conflicts \
            --concise \
            2>&1 | tee deployment-log.txt || true
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Deployment attempted.  Check logs above."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ---------------------------------------------------------
      # 5ï¸âƒ£ Cleanup
      # ---------------------------------------------------------
      - name:  Cleanup
        if:  always()
        run: rm -f authfile. txt
